# ApiProjectMapError 심층 분석 및 해결 가이드

## 현재 확인된 사항

✅ **이미 확인한 항목들:**
1. 결제 계정: 프로젝트에 연결되어 있고, 결제 수단 등록되어 있고, 사용 가능한 카드
2. Maps JavaScript API 활성화: 확인 완료
3. API 키 프로젝트: onepiece 프로젝트의 API 키 확인
4. API 키 제한 설정: 리퍼러 정상 입력, 키 제한 없음/있음 모두 테스트

## ⚠️ 추가로 확인해야 할 항목들

### 1. OAuth 동의 화면 구성 (두 번째 캡처에서 확인됨)

**문제:**
- "이 API와 호환되는 사용자 인증 정보" 섹션에 "OAuth 동의 화면을 구성해야 합니다" 경고가 표시됨
- Maps JavaScript API는 일반적으로 OAuth가 필요하지 않지만, **프로젝트 레벨에서 OAuth 동의 화면이 구성되지 않으면 일부 API가 제대로 작동하지 않을 수 있음**

**해결 방법:**
1. Google Cloud Console에서 **"API 및 서비스" > "OAuth 동의 화면"** 메뉴로 이동
2. **"외부"** 또는 **"내부"** 선택 (일반적으로 "외부" 선택)
3. 필수 정보 입력:
   - **앱 이름**: "OnePiece" 또는 원하는 이름
   - **사용자 지원 이메일**: 본인 이메일
   - **개발자 연락처 정보**: 본인 이메일
4. **"저장 후 계속"** 클릭
5. **"범위"** 단계에서 **"저장 후 계속"** 클릭 (Maps API는 추가 범위가 필요 없음)
6. **"테스트 사용자"** 단계에서 **"저장 후 계속"** 클릭 (필요한 경우)
7. **"요약"** 단계에서 **"대시보드로 돌아가기"** 클릭

**중요**: OAuth 동의 화면을 구성하면 프로젝트가 "검증됨" 상태가 되고, 일부 API 제한이 해제될 수 있습니다.

### 2. 결제 계정의 실제 활성화 상태 확인

**문제:**
- 결제 수단이 등록되어 있어도, **결제 계정 자체가 "활성" 상태가 아닐 수 있음**
- "보류 중" 또는 "비활성" 상태일 수 있음

**확인 방법:**
1. Google Cloud Console에서 **"결제" > "개요"** 메뉴로 이동
2. **결제 계정 상태** 확인:
   - **"활성"**: ✅ 정상
   - **"보류 중"**: ⚠️ 결제 수단 확인 필요
   - **"비활성"**: ❌ 결제 수단 재등록 필요
3. **"결제 계정"** 섹션에서:
   - 결제 계정 이름 클릭
   - **"상태"** 확인
   - **"결제 수단"** 섹션에서 각 결제 수단의 상태 확인

### 3. API 사용량 한도 확인

**문제:**
- API 사용량이 일일 할당량을 초과했을 수 있음
- 무료 할당량이 소진되었을 수 있음

**확인 방법:**
1. Google Cloud Console에서 **"API 및 서비스" > "대시보드"** 메뉴로 이동
2. **"Maps JavaScript API"** 선택
3. **"할당량"** 탭 확인:
   - 일일 요청 수 확인
   - 할당량 초과 여부 확인
4. 할당량이 초과된 경우:
   - **"할당량 증가 요청"** 클릭
   - 또는 다음 날까지 대기

### 4. API 키의 실제 유효성 확인

**문제:**
- API 키가 만료되었거나 비활성화되었을 수 있음
- API 키가 다른 프로젝트로 이동되었을 수 있음

**확인 방법:**
1. Google Cloud Console에서 **"API 및 서비스" > "사용자 인증 정보"** 메뉴로 이동
2. API 키 클릭
3. **"키 제한사항"** 섹션 확인:
   - **"애플리케이션 제한사항"**: 올바르게 설정되어 있는지 확인
   - **"API 제한사항"**: Maps JavaScript API가 포함되어 있는지 확인
4. **"키 상태"** 확인:
   - **"활성"**: ✅ 정상
   - **"비활성"**: ❌ 키가 비활성화됨
5. **"키 표시"** 클릭하여 전체 API 키 확인
6. `.env.local` 파일의 키와 비교:
   ```bash
   # 프론트엔드 디렉토리에서
   cat .env.local | grep GOOGLE_MAPS_API_KEY
   ```

### 5. 프로젝트의 결제 계정 연결 상태 재확인

**문제:**
- 결제 계정이 프로젝트에 연결되어 있지만, **프로젝트 레벨에서 결제가 활성화되지 않았을 수 있음**

**확인 방법:**
1. Google Cloud Console 상단에서 **프로젝트 선택** (onepiece)
2. **"결제" > "결제 계정 연결"** 메뉴로 이동
3. **"결제 계정"** 섹션 확인:
   - 결제 계정이 연결되어 있는지 확인
   - 연결되어 있지 않다면 **"결제 계정 연결"** 클릭
4. **"API 및 서비스" > "사용 설정된 API 및 서비스"** 메뉴로 이동
5. **"Maps JavaScript API"** 클릭
6. **"할당량"** 탭에서 **"결제 계정"** 정보 확인:
   - 결제 계정이 표시되어 있는지 확인
   - 표시되지 않으면 결제 계정이 제대로 연결되지 않은 것

### 6. API 키 제한 설정의 정확성 재확인

**문제:**
- 리퍼러 설정에 오타나 공백이 있을 수 있음
- 포트 번호가 정확하지 않을 수 있음

**확인 방법:**
1. Google Cloud Console에서 **"API 및 서비스" > "사용자 인증 정보"** 메뉴로 이동
2. API 키 클릭
3. **"애플리케이션 제한사항"** 섹션에서:
   - **"HTTP 리퍼러(웹사이트)"** 선택 확인
   - 다음 URL이 **정확히** 입력되어 있는지 확인 (공백, 대소문자, 슬래시 포함):
     ```
     http://localhost:3000/*
     http://127.0.0.1:3000/*
     ```
   - 각 URL이 **별도의 줄**에 있는지 확인
   - URL 끝에 **슬래시와 별표(`/*`)**가 있는지 확인
4. **"저장"** 클릭
5. **5-10분 대기** (설정 적용 시간)

### 7. 브라우저 캐시 및 쿠키 삭제

**문제:**
- 브라우저가 이전 API 키나 설정을 캐시하고 있을 수 있음

**해결 방법:**
1. 브라우저 개발자 도구(F12) 열기
2. **"Application"** 탭 (Chrome) 또는 **"Storage"** 탭 (Firefox) 선택
3. **"Clear storage"** 또는 **"Clear site data"** 클릭
4. 또는 **"Network"** 탭에서 **"Disable cache"** 체크
5. 브라우저 하드 리프레시 (Ctrl+Shift+R 또는 Cmd+Shift+R)

### 8. API 키 재생성 (최후의 수단)

**문제:**
- API 키가 손상되었거나 Google 측에서 제한을 걸었을 수 있음

**해결 방법:**
1. Google Cloud Console에서 **"API 및 서비스" > "사용자 인증 정보"** 메뉴로 이동
2. 기존 API 키 옆의 **"삭제"** 클릭 (또는 비활성화)
3. **"+ 사용자 인증 정보 만들기" > "API 키"** 클릭
4. 새 API 키 생성
5. 새 API 키에 동일한 제한 설정 적용:
   - **애플리케이션 제한사항**: HTTP 리퍼러(웹사이트)
   - **리퍼러 URL**: `http://localhost:3000/*`, `http://127.0.0.1:3000/*`
   - **API 제한사항**: Maps JavaScript API
6. `.env.local` 파일에 새 API 키 업데이트:
   ```env
   NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=새로운_API_키
   ```
7. 프론트엔드 서버 재시작
8. 브라우저 하드 리프레시

## 우선순위별 체크리스트

### 🔴 최우선 (즉시 확인)

1. [ ] **OAuth 동의 화면 구성** (두 번째 캡처에서 확인된 경고)
2. [ ] **결제 계정의 실제 활성화 상태 확인** ("결제" > "개요"에서 상태 확인)
3. [ ] **프로젝트 레벨에서 결제 계정 연결 확인** ("결제" > "결제 계정 연결")

### 🟡 중요 (확인 필요)

4. [ ] **API 사용량 한도 확인** ("API 및 서비스" > "대시보드" > "Maps JavaScript API" > "할당량")
5. [ ] **API 키의 실제 유효성 확인** ("API 및 서비스" > "사용자 인증 정보" > API 키 클릭 > 상태 확인)
6. [ ] **API 키 제한 설정의 정확성 재확인** (리퍼러 URL 오타, 공백 확인)

### 🟢 추가 확인 (문제 지속 시)

7. [ ] **브라우저 캐시 및 쿠키 삭제**
8. [ ] **API 키 재생성** (최후의 수단)

## 예상 결과

위의 모든 항목을 확인하고 수정하면:
- ✅ OAuth 동의 화면 구성으로 프로젝트가 "검증됨" 상태가 됨
- ✅ 결제 계정이 실제로 활성화되어 API가 정상 작동
- ✅ "For development purposes only" 워터마크가 사라짐
- ✅ "Google 지도를 제대로 로드할 수 없습니다" 오류가 해결됨
- ✅ `ApiProjectMapError`가 더 이상 발생하지 않음

---

**가장 중요한 단계**: 
1. **OAuth 동의 화면 구성** (두 번째 캡처에서 확인된 경고 해결)
2. **결제 계정의 실제 활성화 상태 확인** (등록 ≠ 활성화)



